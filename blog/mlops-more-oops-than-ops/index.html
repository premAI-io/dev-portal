<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">MLOps: More Oops than Ops | Prem - Developer Portal</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://dev.premai.io/blog/mlops-more-oops-than-ops"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="title" content="Prem - Developer Portal."><meta data-rh="true" property="og:title" content="MLOps: More Oops than Ops | Prem - Developer Portal"><meta data-rh="true" name="description" content="Navigating the Challenges of Improving Inference Latency for New Large Models through ONNX and TensorRT Optimization."><meta data-rh="true" property="og:description" content="Navigating the Challenges of Improving Inference Latency for New Large Models through ONNX and TensorRT Optimization."><meta data-rh="true" property="og:image" content="https://dev.premai.io/assets/images/banner-b5aa93cec7efb70e4739aa558e1f04cc.png"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-08-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/biswaroop1547,https://github.com/casperdcl"><meta data-rh="true" property="article:tag" content="llm,prem,performance,mlops,onnx,tensorrt"><meta data-rh="true" name="twitter:image" content="./banner.png"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://dev.premai.io/blog/mlops-more-oops-than-ops"><link data-rh="true" rel="alternate" href="https://dev.premai.io/blog/mlops-more-oops-than-ops" hreflang="en"><link data-rh="true" rel="alternate" href="https://dev.premai.io/blog/mlops-more-oops-than-ops" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Prem - Developer Portal RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Prem - Developer Portal Atom Feed">



<script src="https://plausible.io/js/script.js&quot;" defer="defer" data-domain="dev.premai.io"></script><link rel="stylesheet" href="/assets/css/styles.ad8e553d.css">
<link rel="preload" href="/assets/js/runtime~main.8daf300b.js" as="script">
<link rel="preload" href="/assets/js/main.2aea6bdd.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Prem AI logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Prem AI logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Developer Portal</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/premAI-io/prem-app" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/prem-app-network-mode">Contribute GPU to the Prem Network</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/prem-network-launch-p2p-gpu">Prem Network Unveiled: Democratizing AI with Peer-to-Peer GPU Networking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/prem-app-v0-2-enhanced-speed-without-docker">Introducing Prem App v0.2.x: Enhanced Speed and Simplified Usage Without Docker</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/install-prem-on-aws-llmops-in-production">Install Prem on AWS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/evaluating-open-source-llms">Evaluating Open-Source Large Language Models</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://dev.premai.io/assets/images/banner-b5aa93cec7efb70e4739aa558e1f04cc.png"><header><h1 class="title_xvU1" itemprop="headline">MLOps: More Oops than Ops</h1><div class="container_iJTo margin-vert--md"><time datetime="2023-08-16T00:00:00.000Z" itemprop="datePublished">August 16, 2023</time> · <!-- -->14 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://github.com/biswaroop1547" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/biswaroop1547.png" alt="Biswaroop Bhattacharjee"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/biswaroop1547" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Biswaroop Bhattacharjee</span></a></div><small class="avatar__subtitle" itemprop="description">Core contributor @ PremAI</small></div></div></div><div class="col col--6 authorCol_q4o9"><div class="avatar margin-bottom--sm"><a href="https://github.com/casperdcl" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/casperdcl.png" alt="Casper da Costa-Luis"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/casperdcl" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Casper da Costa-Luis</span></a></div><small class="avatar__subtitle" itemprop="description">Core contributor @ PremAI</small></div></div></div></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="Banner" src="/assets/images/banner-b5aa93cec7efb70e4739aa558e1f04cc.png" width="512" height="512" class="img_ev3q"><br>
🤖 <em>image generated using the <a href="https://registry.premai.io/detail.html?service=stable-diffusion-2-1" target="_blank" rel="noopener noreferrer">Stable Diffusion 2.1</a> model mentioned in this post</em></p><p>As model complexity increases exponentially, so too does the need for effective MLOps practices. This post acts as a transparent write-up of all the MLOps frustrations I’ve experienced in the last few days. By sharing my challenges and insights, I hope to contribute to a community that openly discusses and shares solutions for MLOps challenges.</p><p>My goal was to improve Inference latency of few of the current state-of-the-art LLMs.</p><p>Unfortunately, simply downloading trained model weights &amp; existing code doesn&#x27;t solve this problem.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-promise-of-faster-inference">The Promise of Faster Inference<a href="#the-promise-of-faster-inference" class="hash-link" aria-label="Direct link to The Promise of Faster Inference" title="Direct link to The Promise of Faster Inference">​</a></h2><p>My first target here was <a href="http://registry.premai.io/detail.html?service=llama-2-7b-chat" target="_blank" rel="noopener noreferrer">Llama 2</a>. I wanted to convert it into <a href="https://onnx.ai" target="_blank" rel="noopener noreferrer">ONNX</a> format, which could then be converted to <a href="https://developer.nvidia.com/tensorrt-getting-started" target="_blank" rel="noopener noreferrer">TensorRT</a>, and finally served using <a href="https://developer.nvidia.com/triton-inference-server" target="_blank" rel="noopener noreferrer">Triton Inference Server</a>.</p><p>TensorRT optimizes the model network by combining layers and optimizing kernel selection for improved latency, throughput, power efficiency and memory consumption. If the application specifies, it will additionally optimize the network to run in lower precision, further increasing performance and reducing memory requirements.</p><p>From online benchmarks [<a href="https://github.com/kentaroy47/benchmark-FP32-FP16-INT8-with-TensorRT" target="_blank" rel="noopener noreferrer">1</a>, <a href="https://medium.com/@abhismatrix/speeding-deep-learning-inference-by-upto-20x-6c0c0f6fba81" target="_blank" rel="noopener noreferrer">2</a>] it seems possible to achieve a 2~3x boost to latency (by reducing precision without hurting quality much). But the workings for these kind of format conversions feel super flaky, things break too often (without any solution to be found online). Yes, it’s somewhat expected since these models are so new, with different architectures using different (not yet widely-supported) layers and operators.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="model-conversion-errors">Model Conversion Errors<a href="#model-conversion-errors" class="hash-link" aria-label="Direct link to Model Conversion Errors" title="Direct link to Model Conversion Errors">​</a></h2><p>Let’s start with <strong>Llama 2 7B chat</strong>,</p><ol><li>Firstly I’ve downloaded Llama-2-7B-Chat weights from Meta’s Official repository <a href="https://github.com/facebookresearch/llama" target="_blank" rel="noopener noreferrer">here</a> after requesting.</li><li>Convert raw weights to huggingface format using <a href="https://github.com/huggingface/transformers/blob/main/src/transformers/models/llama/convert_llama_weights_to_hf.py" target="_blank" rel="noopener noreferrer">this</a> script by Huggingface. Let’s say we save it under <code>llama-2-7b-chat-hf</code> directory locally.</li></ol><p>Now I considered two options for converting huggingface models to ONNX format:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchonnxexport-gibberish-text"><code>torch.onnx.export</code> gibberish text<a href="#torchonnxexport-gibberish-text" class="hash-link" aria-label="Direct link to torchonnxexport-gibberish-text" title="Direct link to torchonnxexport-gibberish-text">​</a></h3><p>Let’s write an <code>export_to_onnx</code> function which will load the tokenizer &amp; model, and export it into ONNX format:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> composer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">utils </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> parse_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> reproducibility</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> pathlib </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> AutoConfig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> AutoModelForCausalLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> AutoTokenizer</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">export_to_onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    pretrained_model_name_or_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    output_folder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    verify_export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bool</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    max_seq_len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> </span><span class="token boolean" style="color:#569CD6">None</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token boolean" style="color:#569CD6">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    reproducibility</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">seed_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#B5CEA8">42</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    _</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> parsed_save_path </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> parse_uri</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_folder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Load HF config/model/tokenizer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    tokenizer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pretrained_model_name_or_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_fast</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    config </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoConfig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pretrained_model_name_or_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">if</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">hasattr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;attn_config&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">attn_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;attn_impl&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;torch&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoModelForCausalLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">pretrained_model_name_or_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> config</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda:0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">eval</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># tips: https://huggingface.co/docs/transformers/v4.31.0/en/model_doc/llama2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_special_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pad_token&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;pad&gt;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">resize_token_embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pad_token_id </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">pad_token_id</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    sample_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Hello, my dog is cute&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        padding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max_length&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">max_seq_len </span><span class="token keyword" style="color:#C586C0">or</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">max_seq_len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        truncation</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        add_special_tokens</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda:0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    output_file </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">parsed_save_path</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;model.onnx&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mkdir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">parents</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> exist_ok</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)"># Put sample input on cpu for export</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    sample_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#C586C0">in</span><span class="token plain"> sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cpu&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">export</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        input_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;input_ids&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;attention_mask&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        output_names</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;output&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        opset_version</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can also check if the exported &amp; original models&#x27; outputs are similar:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token comment" style="color:rgb(106, 153, 85)"># (Optional) verify onnx model outputs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">checker</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnxruntime </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> ort</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    orig_out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    orig_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">logits </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> orig_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">logits</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># put on cpu for export</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">_ </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">load</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">checker</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">check_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">ort_session </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ort</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">InferenceSession</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> value </span><span class="token keyword" style="color:#C586C0">in</span><span class="token plain"> sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">items</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">numpy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">loaded_model_out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ort_session</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean" style="color:#569CD6">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> sample_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">testing</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">assert_close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    orig_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">logits</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">detach</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">numpy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    loaded_model_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    rtol</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1e-2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    atol</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1e-2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    msg</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&#x27;output mismatch between the orig and onnx exported model&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;Success: exported &amp; original model outputs match&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Assuming we&#x27;ve saved the ONNX model in <code>./llama-2-7b-onnx/</code>, we can now run inference using <code>onnxruntime</code>:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">checker</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> onnxruntime </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> ort</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> AutoModelForCausalLM</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">output_file </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;llama-2-7b-onnx/model.onnx&#x27;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># converted model from above</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">ort_session </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ort</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">InferenceSession</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">output_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">tokenizer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;llama-2-7b-chat-hf&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_fast</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_special_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pad_token&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&lt;pad&gt;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Hello, my dog is cute&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    padding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max_length&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    truncation</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;np&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    add_special_tokens</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">loaded_model_out </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ort_session</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">run</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean" style="color:#569CD6">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">batch_decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tensor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">loaded_model_out</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>😖 On my machine, this generates really funky outputs:</p><p><code>ЉЉЉЉЉЉ\n\n\n\n\n\n\n\n\n\n Hello Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis Hinweis..........SMSMSMSMSMSMSMSMSMSMSMS Unterscheidung, I name is ough,</code></p><p>... which is mostly due to missing a proper decoding strategy (<a href="https://docs.cohere.com/docs/controlling-generation-with-top-k-top-p#1-pick-the-top-token-greedy-decoding" target="_blank" rel="noopener noreferrer">greedy</a>, <a href="https://machinelearningmastery.com/beam-search-decoder-natural-language-processing" target="_blank" rel="noopener noreferrer">beam</a>, etc.) while generating tokens.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimum-cli-gibberish-text-and-tensorrt-slowness"><code>optimum-cli</code> gibberish text and <code>tensorrt</code> slowness<a href="#optimum-cli-gibberish-text-and-tensorrt-slowness" class="hash-link" aria-label="Direct link to optimum-cli-gibberish-text-and-tensorrt-slowness" title="Direct link to optimum-cli-gibberish-text-and-tensorrt-slowness">​</a></h3><p>To solve the problem above, we can try a different exporter which includes decoding strategies.</p><p>Using the <a href="https://huggingface.co/docs/transformers/serialization#export-to-onnx" target="_blank" rel="noopener noreferrer">Optimum ONNX exporter</a> instead (assuming the original model is in <code>./llama-2-7b-chat-hf/</code>), we can do:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">optimum-cli export onnx \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --model ./llama-2-7b-chat-hf/ --task text-generation --framework pt \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --opset 16 --sequence_length 1024 --batch_size 1 --device cuda --fp16 \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  llama-2-7b-optimum/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>⌛ This takes a few minutes to generate. If you don’t has a GPU for this conversion, then remove <code>--device cuda</code> from the above command.</p><p>The result is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">llama-2-7b-optimum</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── config.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── Constant_162_attr__value</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── Constant_170_attr__value</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── decoder_model.onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── decoder_model.onnx_data</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── generation_config.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── special_tokens_map.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── tokenizer_config.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> ├── tokenizer.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"> └── tokenizer.model</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now when I try to do inference using <code>optimum.onnxruntime.ORTModelForCausalLM</code>, things work fine (though slowly) using the <code>CPUExecutionProvider</code>:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> AutoTokenizer</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> optimum</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">onnxruntime </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> ORTModelForCausalLM</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">tokenizer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;./onnx_optimum&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ORTModelForCausalLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;./onnx_optimum/&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_cache</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_io_binding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;My name is Arthur and I live in&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">gen_tokens </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">assert</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">providers </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;CPUExecutionProvider&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">batch_decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gen_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After waiting a long time, we get a result:</p><p><code>&lt;s&gt; My name is Arthur and I live in a small town in the countr</code></p><p>But when switching to the faster <code>CUDAExecutionProvider</code>, I get gibberish text on inference:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> ORTModelForCausalLM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;./onnx_optimum/&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_cache</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> use_io_binding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> provider</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CUDAExecutionProvider&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;My name is Arthur and I live in&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">gen_tokens </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">assert</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">providers </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;CUDAExecutionProvider&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;CPUExecutionProvider&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">batch_decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gen_tokens</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token number" style="color:#B5CEA8">2023</span><span class="token number" style="color:#B5CEA8">-08</span><span class="token number" style="color:#B5CEA8">-02</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">19</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">47</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">43.534099146</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">W</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain">onnxruntime</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> session_state.cc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">1169</span><span class="token plain"> VerifyEachNodeIsAssignedToAnEp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Some nodes were not assigned to the preferred execution providers which may or may not</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">have an negative impact on performance. e.g. ORT explicitly assigns shape related ops</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">to CPU to improve perf.</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2023</span><span class="token number" style="color:#B5CEA8">-08</span><span class="token number" style="color:#B5CEA8">-02</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">19</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">47</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">43.534136078</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">W</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain">onnxruntime</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> session_state.cc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">1171</span><span class="token plain"> VerifyEachNodeIsAssignedToAnEp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Rerunning with verbose output on a non-minimal build will show node assignments.</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">&lt;s&gt; My name is Arthur and I live in a&lt;unk&gt;&lt;unk&gt;&lt;unk&gt;&lt;unk&gt;&lt;unk&gt;&lt;unk&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Even with different <code>temperature</code> and other parameter values, it always yields unintelligible outputs, as reported in <a href="https://github.com/huggingface/optimum/issues/1248" target="_blank" rel="noopener noreferrer">optimum#1248</a>.</p><p>🎉 <strong>Update</strong>: after about a week this issue seemed to magically disappear — possibly due to a new version of <code>llama-2-7b-chat-hf</code> being released.</p><p>Using the new model with <code>max_length=128</code>, :</p><ul><li>Prompt: <em>Why should one run Machine learning model on-premises?</em><ul><li>ONNX inference latency: <code>2.31s</code></li><li>HuggingFace version latency: <code>3s</code></li></ul></li></ul><p>🚀 The ONNX model is ~23% faster than the HuggingFace variant!</p><p>⚠️ However, while both CPU and CUDA providers work, there now seems to be a bug when trying <code>TensorrtExecutionProvider</code> — reported in <a href="https://github.com/huggingface/optimum/issues/1278" target="_blank" rel="noopener noreferrer">optimum#1278</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="optimum-cli-segfaults"><code>optimum-cli</code> segfaults<a href="#optimum-cli-segfaults" class="hash-link" aria-label="Direct link to optimum-cli-segfaults" title="Direct link to optimum-cli-segfaults">​</a></h3><p>Next let’s try with the <a href="https://huggingface.co/databricks/dolly-v2-7b" target="_blank" rel="noopener noreferrer"><strong>Dolly-v2 7B</strong></a> from <a href="https://www.databricks.com/blog/2023/04/12/dolly-first-open-commercially-viable-instruction-tuned-llm" target="_blank" rel="noopener noreferrer">Databricks</a>. The equivalent <code>optimum-cli</code> command for ONNX conversion would be:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">optimum-cli export onnx \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --model &#x27;databricks/dolly-v2-7b&#x27; --task text-generation --framework pt \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --opset 17 --sequence_length 1024 --batch_size 1 --fp16 --device cuda \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  dolly_optimum</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>😢 It uses around 17GB of my GPU RAM, seemingly working fine but finally ending with a segmentation fault:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">======= Diagnostic Run torch.onnx.export version </span><span class="token number" style="color:#B5CEA8">2.1</span><span class="token plain">.</span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain">.dev20230804+cu118 =======</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">verbose</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> False</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> log level</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">======================= </span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain"> NONE </span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain"> NOTE </span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain"> WARNING </span><span class="token number" style="color:#B5CEA8">0</span><span class="token plain"> ERROR ========================</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Saving external data to one file...</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2023</span><span class="token number" style="color:#B5CEA8">-08</span><span class="token number" style="color:#B5CEA8">-09</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">20</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">59</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">33.334484259</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">W</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain">onnxruntime</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> session_state.cc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">1169</span><span class="token plain"> VerifyEachNodeIsAssignedToAnEp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Some nodes were not assigned to the preferred execution providers which may or may not</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">have an negative impact on performance. e.g. ORT explicitly assigns shape related ops</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">to CPU to improve perf.</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token number" style="color:#B5CEA8">2023</span><span class="token number" style="color:#B5CEA8">-08</span><span class="token number" style="color:#B5CEA8">-09</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">20</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">59</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">33.334531829</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">W</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain">onnxruntime</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> session_state.cc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token number" style="color:#B5CEA8">1171</span><span class="token plain"> VerifyEachNodeIsAssignedToAnEp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Rerunning with verbose output on a non-minimal build will show node assignments.</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Asked a sequence length of </span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> but a sequence length of </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"> will be used with</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">use_past == True for `input_ids`.</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Post-processing the exported models...</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">Segmentation fault (core dumped)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Confusingly, despite this error, all model files seem to be converted and saved to disk. Other people have reported similar segfault issues while exporting (<a href="https://github.com/huggingface/transformers/issues/21360" target="_blank" rel="noopener noreferrer">transformers#21360</a>, <a href="https://github.com/huggingface/optimum/issues/798" target="_blank" rel="noopener noreferrer">optimum#798</a>).</p><p>Results using the Dolly v2 model:</p><ul><li>Prompt: <em>Why should one run Machine learning model on-premises?</em><ul><li>ONNX inference latency: <code>8.2s</code></li><li>HuggingFace version latency: <code>5.2s</code></li></ul></li></ul><p>😠 The ONNX model is actually ~58% slower than the HuggingFace variant!</p><p>To make things faster, we can try to optimize the model:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">optimum-cli onnxruntime optimize -O4 --onnx_model ./dolly_optimum/ -o dolly_optimized/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <a href="https://huggingface.co/docs/optimum/main/en/onnxruntime/usage_guides/optimization" target="_blank" rel="noopener noreferrer">different optimization levels</a> are:</p><ul><li><code>-O1</code>: basic general optimizations.</li><li><code>-O2</code>: basic and extended general optimizations, transformers-specific fusions.</li><li><code>-O3</code>: same as O2 with GELU approximation.</li><li><code>-O4</code>: same as O3 with mixed precision (fp16, GPU-only).</li></ul><p>We still get the same segfault error for all of the levels.</p><p>For <code>-O1</code>, the model gets saved but there’s no noticeable performance change. For <code>-O2</code> it gets killed (even though I have 40GB A100 GPU + 80GB CPU RAM). Meanwhile for <code>-O3</code> &amp; <code>-O4</code> it gives seg-fault (above) while only partially saving the model files.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="torchonnxexport-gibberish-images"><code>torch.onnx.export</code> gibberish images<a href="#torchonnxexport-gibberish-images" class="hash-link" aria-label="Direct link to torchonnxexport-gibberish-images" title="Direct link to torchonnxexport-gibberish-images">​</a></h3><p>Moving on from text-based models, let’s now look at an image generator. We can try to speed up the <a href="https://huggingface.co/stabilityai/stable-diffusion-2-1" target="_blank" rel="noopener noreferrer"><strong>Stable Diffusion 2.1</strong></a> model. In an IPython shell:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> diffusers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> StableDiffusionPipeline</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">pipe </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> StableDiffusionPipeline</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;stabilityai/stable-diffusion-2-1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> torch_dtype</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">float16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda:0&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">time img </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Iron man laughing&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> num_inference_steps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> num_images_per_prompt</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;iron_man.png&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;PNG&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The latency (as measured by the <code>%time</code> magic) is <code>3.25 s</code>.</p><p>To convert to ONNX format, we can use <a href="https://github.com/huggingface/diffusers/blob/main/scripts/convert_stable_diffusion_checkpoint_to_onnx.py" target="_blank" rel="noopener noreferrer">this script</a>:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">python convert_stable_diffusion_checkpoint_to_onnx.py \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --model_path stabilityai/stable-diffusion-2-1 \</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  --output_path sd_onnx/ --opset 16 --fp16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>ℹ️ Note: if a model uses operators unsupported by the <code>opset</code> number above, you&#x27;ll have to upgrade <code>pytorch</code> to the nightly build:</p><div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">pip uninstall torch</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">pip install --pre torch --index-url https://download.pytorch.org/whl/nightly/cu121</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote><p>The result is:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">sd_onnx/</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── model_index.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── scheduler</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   └── scheduler_config.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── text_encoder</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   └── model.onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── tokenizer</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   ├── merges.txt</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   ├── special_tokens_map.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   ├── tokenizer_config.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   └── vocab.json</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── unet</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   ├── model.onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   └── weights.pb</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">├── vae_decoder</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">│   └── model.onnx</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">└── vae_encoder</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    └── model.onnx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There’s a separate ONNX model for each Stable Diffusion subcomponent model.</p><p>Now to benchmark this similarly we can do the following:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> diffusers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> OnnxStableDiffusionPipeline</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">pipe </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> OnnxStableDiffusionPipeline</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sd_onnx&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> provider</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;CUDAExecutionProvider&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token operator" style="color:rgb(212, 212, 212)">%</span><span class="token plain">time img </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> pipe</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Iron man laughing&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> num_inference_steps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">20</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> num_images_per_prompt</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">img</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;iron_man.png&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">format</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;PNG&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The overall performance results look great, at ~59% faster! We also didn’t see any noticeable quality difference between the models.</p><ul><li>Prompt: <em>Iron man laughing</em><ul><li>ONNX inference latency: <code>1.34s</code></li><li>HuggingFace version latency: <code>3.25s</code></li></ul></li></ul><p>Since we know that the <code>unet</code> model is the bottleneck, taking ~90% of the compute time, we can focus on it for further optimization. We try to serialize the ONNX version of the UNet to a TensorRT engine compatible format. When building the engine, the builder object selects the most optimized kernels for the chosen platform and configuration. Building the engine from a network definition file can be time consuming, and should not be repeated each time we need to perform inference unless the model/platform/configuration changes. You can transform the format of the engine after generation and save it to disk for later reuse (known as <a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-developer-guide/index.html#serial_model_c" target="_blank" rel="noopener noreferrer"><em>serializing</em> the engine</a>). Deserializing occurs when you load the engine from disk into memory:</p><p><a href="https://developer.nvidia.com/blog/speed-up-inference-tensorrt" target="_blank" rel="noopener noreferrer"><img loading="lazy" alt="https://developer.nvidia.com/blog/speed-up-inference-tensorrt/" src="/assets/images/tensorrt-7a9261ec965b947b82c66f8810121e94.png" width="625" height="292" class="img_ev3q"></a></p><p>To setup TensorRT properly, follow <a href="https://onnxruntime.ai/docs/execution-providers/TensorRT-ExecutionProvider.html#requirements" target="_blank" rel="noopener noreferrer">this support table</a>. It’s a bit painful, and (similar to <a href="https://nvcr.io/cuda/cudnn" target="_blank" rel="noopener noreferrer">cuda/cudnn</a>) if you just want a quick solution you can use NVIDIA’s <a href="https://nvcr.io/nvidia/tensorrt:22.12-py3" target="_blank" rel="noopener noreferrer"><code>tensorrt:22.12-py3</code> docker image</a> as a base:</p><div class="language-docker codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-docker codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token plain">FROM nvcr.io/nvidia/tensorrt:22.12-py3</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">ENV CUDA_MODULE_LOADING=LAZY</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">RUN pip install ipython transformers optimum[onnxruntime-gpu] onnx diffusers accelerate scipy safetensors composer</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">RUN pip uninstall torch -y &amp;&amp; pip install --pre torch --index-url https://download.pytorch.org/whl/nightly/cu121</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">COPY sd_onnx sd_onnx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can then use the following script for serialization:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> tensorrt </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> trt</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">onnx_model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sd_onnx/unet/model.onnx&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">engine_filename </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;unet.trt&quot;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># saved serialized tensorrt engine file path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># constants</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">batch_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">height </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">512</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">width </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">512</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">latents_shape </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> height </span><span class="token operator" style="color:rgb(212, 212, 212)">//</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> width </span><span class="token operator" style="color:rgb(212, 212, 212)">//</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># shape required by Stable Diffusion 2.1&#x27;s UNet model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">embed_shape </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1024</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">timestep_shape </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">TRT_LOGGER </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Logger</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">INFO</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">TRT_BUILDER </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">Builder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TRT_LOGGER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">network </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TRT_BUILDER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create_network</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">NetworkDefinitionCreationFlag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">EXPLICIT_BATCH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">config </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TRT_BUILDER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create_builder_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">profile </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TRT_BUILDER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">create_optimization_profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Loading &amp; validating ONNX model&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">onnx_parser </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">OnnxParser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> TRT_LOGGER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">parse_success </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> onnx_parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">parse_from_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">onnx_model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">for</span><span class="token plain"> idx </span><span class="token keyword" style="color:#C586C0">in</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">range</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">onnx_parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">num_errors</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">onnx_parser</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">get_error</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">if</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">not</span><span class="token plain"> parse_success</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">raise</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;ONNX model parsing failed&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># set input, latent and other shapes required by the layers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;sample&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> latents_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> latents_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> latents_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;encoder_hidden_states&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> embed_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> embed_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> embed_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;timestep&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timestep_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timestep_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timestep_shape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">add_optimization_profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">profile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_flag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">BuilderFlag</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">FP16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&quot;Serializing &amp; saving engine to &#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation">engine_filename</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&#x27;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">serialized_engine </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TRT_BUILDER</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">build_serialized_network</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">network</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">with</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">open</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">engine_filename</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;wb&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">serialized_engine</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let’s move to deserializing <code>unet.trt</code> for inference. We&#x27;ll use the <code>TRTModel</code> class from <a href="https://github.com/stochasticai/x-stable-diffusion/blob/main/TensorRT/trt_model.py" target="_blank" rel="noopener noreferrer">x-stable-diffusion&#x27;s <code>trt_model</code></a>:</p><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#212121"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> tensorrt </span><span class="token keyword" style="color:#C586C0">as</span><span class="token plain"> trt</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">trt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">init_libnvinfer_plugins</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token boolean" style="color:#569CD6">None</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> pycuda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">autoinit</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> diffusers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> AutoencoderKL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> LMSDiscreteScheduler</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> PIL </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> Image</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> torch </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> autocast</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> CLIPTextModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> CLIPTokenizer</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> trt_model </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> TRTModel</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">from</span><span class="token plain"> tqdm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">contrib </span><span class="token keyword" style="color:#C586C0">import</span><span class="token plain"> tenumerate</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#C586C0">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">TrtDiffusionModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">__init__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unet </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TRTModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;./unet.trt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># tensorrt engine saved path</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vae </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> AutoencoderKL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;stabilityai/stable-diffusion-2-1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> subfolder</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;vae&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenizer </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> CLIPTokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;stabilityai/stable-diffusion-2-1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> subfolder</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;tokenizer&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text_encoder </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> CLIPTextModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;stabilityai/stable-diffusion-2-1&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> subfolder</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;text_encoder&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> LMSDiscreteScheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            beta_start</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">0.00085</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            beta_end</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">0.012</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            beta_schedule</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;scaled_linear&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            num_train_timesteps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">1000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#C586C0">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> num_inference_steps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> height</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> width</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> max_seq_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        guidance_scale </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">7.5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        batch_size </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        text_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            prompts</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            padding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max_length&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">max_seq_length</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            truncation</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        text_embeddings </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text_encoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">text_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        uncond_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tokenizer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            padding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;max_length&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            max_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">max_seq_length</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            return_tensors</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;pt&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        uncond_embeddings </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">text_encoder</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">uncond_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        text_embeddings </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">uncond_embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> text_embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        latents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> height </span><span class="token operator" style="color:rgb(212, 212, 212)">//</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> width </span><span class="token operator" style="color:rgb(212, 212, 212)">//</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">8</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">set_timesteps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">num_inference_steps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        latents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> latents </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sigmas</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token keyword" style="color:#C586C0">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">inference_mode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> autocast</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;cuda&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token keyword" style="color:#C586C0">for</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> t </span><span class="token keyword" style="color:#C586C0">in</span><span class="token plain"> tenumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">timesteps</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                latent_model_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">latents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                sigma </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sigmas</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                latent_model_input </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> latent_model_input </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">sigma</span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">**</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0.5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># predict the noise residual</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                inputs </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                    latent_model_input</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                    torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tensor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">device</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                    text_embeddings</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                noise_pred </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">unet</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">inputs</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> timing</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean" style="color:#569CD6">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                noise_pred </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">noise_pred</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">batch_size</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">4</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                noise_pred_uncond</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> noise_pred_text </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> noise_pred</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">chunk</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                noise_pred </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> noise_pred_uncond </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> guidance_scale </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                    noise_pred_text </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> noise_pred_uncond</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># compute the previous noisy sample x_t -&gt; x_t-1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">                latents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">step</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">noise_pred</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> latents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;prev_sample&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            </span><span class="token comment" style="color:rgb(106, 153, 85)"># scale and decode the image latents with VAE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            latents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0.18215</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> latents</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">            image </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">vae</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">latents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">sample</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">        </span><span class="token keyword" style="color:#C586C0">return</span><span class="token plain"> image</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">model </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TrtDiffusionModel</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">image </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">predict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    prompts</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;Iron man laughing, real photoshoot&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    num_inference_steps</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">25</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    height</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    width</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">512</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    max_seq_length</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:#B5CEA8">64</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">image </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">image </span><span class="token operator" style="color:rgb(212, 212, 212)">/</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">0.5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">clamp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">image </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">detach</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">permute</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">3</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">numpy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">images </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">image </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain"> </span><span class="token number" style="color:#B5CEA8">255</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token builtin" style="color:rgb(86, 156, 214)">round</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">astype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;uint8&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">pil_images </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fromarray</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C586C0">for</span><span class="token plain"> image </span><span class="token keyword" style="color:#C586C0">in</span><span class="token plain"> images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">pil_images</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:#B5CEA8">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;image_generated.png&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above script runs, but the generated output looks like this:</p><table><thead><tr><th align="center"><img loading="lazy" alt="blank" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAi0AAAIxCAYAAACB/YiSAAAABHNCSVQICAgIfAhkiAAAGl9JREFUeF7t2UEKg0AURMEx6kjw/ueNyS5HmAcluG/q96JhtjHG5/v7CBAgQIAAAQLLCszrHq9l0wlGgAABAgQIEPgTMFrUgQABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQMBo0QECBAgQIEAgIWC0JM4kJAECBAgQIGC06AABAgQIECCQEDBaEmcSkgABAgQIEDBadIAAAQIECBBICBgtiTMJSYAAAQIECBgtOkCAAAECBAgkBIyWxJmEJECAAAECBIwWHSBAgAABAgQSAkZL4kxCEiBAgAABAkaLDhAgQIAAAQIJAaMlcSYhCRAgQIAAAaNFBwgQIECAAIGEgNGSOJOQBAgQIECAgNGiAwQIECBAgEBCwGhJnElIAgQIECBAwGjRAQIECBAgQCAhYLQkziQkAQIECBAgYLToAAECBAgQIJAQMFoSZxKSAAECBAgQMFp0gAABAgQIEEgIGC2JMwlJgAABAgQIGC06QIAAAQIECCQEjJbEmYQkQIAAAQIEjBYdIECAAAECBBICRkviTEISIECAAAECRosOECBAgAABAgkBoyVxJiEJECBAgAABo0UHCBAgQIAAgYSA0ZI4k5AECBAgQICA0aIDBAgQIECAQELAaEmcSUgCBAgQIEDAaNEBAgQIECBAICFgtCTOJCQBAgQIECBgtOgAAQIECBAgkBAwWhJnEpIAAQIECBAwWnSAAAECBAgQSAgYLYkzCUmAAAECBAgYLTpAgAABAgQIJASMlsSZhCRAgAABAgSMFh0gQIAAAQIEEgJGS+JMQhIgQIAAAQJGiw4QIECAAAECCQGjJXEmIQkQIECAAAGjRQcIECBAgACBhIDRkjiTkAQIECBAgIDRogMECBAgQIBAQsBoSZxJSAIECBAgQOCY102BAAECBAgQILC0wL6f4zjne+mQwhEgQIAAAQIEfgKeh/SAAAECBAgQSAg8j5QFtBkJJD0AAAAASUVORK5CYII=" width="557" height="561" class="img_ev3q"></th><th align="center"><img loading="lazy" alt="noise" src="/assets/images/noise_image-bb7a3a7f753f1126b474a6952fa09b13.png" width="379" height="377" class="img_ev3q"></th></tr></thead></table><p>Something’s going wrong, and changing to different tensor shapes (defined above) also doesn’t help fix the generation of blank/noisy images.</p><p>I don&#x27;t know how to make Stable Diffusion 2.1 work with TensorRT, though it&#x27;s proved possible for other Stable Diffusion variants in <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui" target="_blank" rel="noopener noreferrer">AUTOMATIC1111/stable-diffusion-webui</a>. Others reporting similar issues in <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/issues/5503#issuecomment-1341495770" target="_blank" rel="noopener noreferrer">stable-diffusion-webui#5503</a> have suggested:</p><ul><li>Use more than 16-bits: I did, but it didn&#x27;t help.</li><li>Use <code>xformers</code>: For our model we need <a href="https://github.com/pytorch/pytorch/issues/97262" target="_blank" rel="noopener noreferrer"><code>pytorch</code>&#x27;s recently added <code>scaled_dot_product_attention</code> operator</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-frustrations">Other Frustrations<a href="#other-frustrations" class="hash-link" aria-label="Direct link to Other Frustrations" title="Direct link to Other Frustrations">​</a></h2><p>Maybe the code above is paritally in my control, but there are also other issues that have nothing to do with my code:</p><ul><li>Licences: <a href="https://huggingface.github.io/text-generation-inference" target="_blank" rel="noopener noreferrer">Text Generation Inference</a> recently they came up with <a href="https://twitter.com/jeffboudier/status/1685001126780026880?s=20" target="_blank" rel="noopener noreferrer">a new license</a> which is more restrictive for newer versions. I can only use old releases (up to v0.9).</li><li>Lack of GPU support: <a href="https://github.com/ggerganov/ggml" target="_blank" rel="noopener noreferrer">GGML</a> doesn&#x27;t currently support GPU inference, so I can&#x27;t use it if I want very low latency.</li><li>Quality: I&#x27;ve heard from peers that saw a big decrease in output quality <a href="https://github.com/vllm-project/vllm" target="_blank" rel="noopener noreferrer">vLLM</a>. I&#x27;d like to explore this in future.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2><p>I&#x27;ve listed my recent errors and frustrations. I need more time to dig deeper and solve them, but if you think you can help please do reply in any of the issues linked above! By sharing my experiences and challenges, I hope this can spark lots of discussions and new ideas. Maybe you&#x27;ve faced something similar?</p><p>While the world likes showcasing the latest advancements and shiny results, it&#x27;s important to also acknowledge and address the underlying complexities that come with deploying &amp; maintaining ML models. There&#x27;s a scarcity of documentation/resources for these problems in the ML community. As the field continues to rapidly evolve, there is a need for more in-depth discussions and solutions to these technical hurdles.</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_Wr5y"><div class="col"><ul class="tags_ysAR padding--none"><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/prem">prem</a></li><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/performance">performance</a></li><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mlops">mlops</a></li><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/onnx">onnx</a></li><li class="tag_DyE2"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tensorrt">tensorrt</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/premAI-io/dev-portal/blob/main/blog/2023-08-16-mlops-more-oops-than-ops/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/evaluating-open-source-llms"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Evaluating Open-Source Large Language Models</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/teach-chatbot-with-audio"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Teach a Q&amp;A Chatbot with Audio Recordings</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-promise-of-faster-inference" class="table-of-contents__link toc-highlight">The Promise of Faster Inference</a></li><li><a href="#model-conversion-errors" class="table-of-contents__link toc-highlight">Model Conversion Errors</a><ul><li><a href="#torchonnxexport-gibberish-text" class="table-of-contents__link toc-highlight"><code>torch.onnx.export</code> gibberish text</a></li><li><a href="#optimum-cli-gibberish-text-and-tensorrt-slowness" class="table-of-contents__link toc-highlight"><code>optimum-cli</code> gibberish text and <code>tensorrt</code> slowness</a></li><li><a href="#optimum-cli-segfaults" class="table-of-contents__link toc-highlight"><code>optimum-cli</code> segfaults</a></li><li><a href="#torchonnxexport-gibberish-images" class="table-of-contents__link toc-highlight"><code>torch.onnx.export</code> gibberish images</a></li></ul></li><li><a href="#other-frustrations" class="table-of-contents__link toc-highlight">Other Frustrations</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/prem" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.com/invite/kpKk6vYVAn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/premai_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/premAI-io" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Prem Labs, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8daf300b.js"></script>
<script src="/assets/js/main.2aea6bdd.js"></script>
</body>
</html>